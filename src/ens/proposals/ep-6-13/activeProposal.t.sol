// SPDX-License-Identifier: MIT
pragma solidity >=0.8.25 <0.9.0;

import { Test } from "@forge-std/src/Test.sol";
import { console2 } from "@forge-std/src/console2.sol";

import { ENS_Governance } from "@ens/ens.t.sol";
import { IERC20 } from "@contracts/utils/interfaces/IERC20.sol";
import { IUSDCx } from "@ens/interfaces/IUSDCx.sol";
import { CFAv1Forwarder } from "@ens/interfaces/ISuperfluidCFAv1Forwarder.sol";

contract Proposal_ENS_EP_6_13_Test is ENS_Governance {
    // Contract addresses
    IERC20 public constant USDC = IERC20(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48);
    IUSDCx public constant USDCx = IUSDCx(0x1BA8603DA702602A8657980e825A6DAa03Dee93a);
    CFAv1Forwarder public constant SUPERFLUID = CFAv1Forwarder(0xcfA132E353cB4E398080B9700609bb008eceB125);
    
    // Flow parameters
    address public streamPod = 0xB162Bf7A7fD64eF32b787719335d06B2780e31D1;
    address public autowrapper = 0x1D65c6d3AD39d454Ea8F682c49aE7744706eA96d;
    
    // Amounts and flow rates
    uint256 public constant INITIAL_USDC_AMOUNT = 375_000_000_000; // 375,000 USDC (6 decimals)
    uint256 public constant UPGRADE_AMOUNT = 375_000_000_000_000_000_000_000; // 375,000 USDCx (18 decimals)
    int96 public constant NEW_FLOW_RATE = 142_599_440_769_357_573; // ~$4.5M/year
    uint256 public constant AUTOWRAP_ALLOWANCE = 6_375_000_000_000; // 6.375M USDC

    int96 currentFlowRate;
    uint256 currentUSDCxBalanceTimelock;
    uint256 currentUSDCxBalanceStreamPod;
    uint256 currentUSDCApproval;
    uint256 currentAutowrapAllowance;
    
    bytes proposalCalldata =
        hex"0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000012000000000000000000000000000000000000000000000000000000000000001c000000000000000000000000000000000000000000000000000000000000004600000000000000000000000000000000000000000000000000000000000000004000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb480000000000000000000000001ba8603da702602a8657980e825a6daa03dee93a000000000000000000000000cfa132e353cb4e398080b9700609bb008eceb125000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000044095ea7b30000000000000000000000001ba8603da702602a8657980e825a6daa03dee93a000000000000000000000000000000000000000000000000000000574fbde60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002445977d03000000000000000000000000000000000000000000004f68ca6d8cd91c60000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000006457e6aa360000000000000000000000001ba8603da702602a8657980e825a6daa03dee93a000000000000000000000000b162bf7a7fd64ef32b787719335d06b2780e31d100000000000000000000000000000000000000000000000001fa9d6f943a1705000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044095ea7b30000000000000000000000001d65c6d3ad39d454ea8f682c49ae7744706ea96d000000000000000000000000000000000000000000000000000005cc4b9c460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000180423205b455020362e31335d205b436f727265637465645d205b45786563757461626c655d202d2053505020536561736f6e203220496d706c656d656e746174696f6e0a232320436f7272656374696f6e0a0a5468652070726576696f75732076657273696f6e206f6620746869732070726f706f73616c2068617320696e636f7272656374207465787420696e20746865206465736372697074696f6e2e2020546869732076657273696f6e20697320636f727265637465642e0a0a23232041627374726163740a0a546869732065786563757461626c652070726f706f73616c20696d706c656d656e74732074686520536572766963652050726f76696465722050726f6772616d20536561736f6e20322028535050322920666f6c6c6f77696e672074686520617070726f76616c206f66205b455020362e31305d2868747470733a2f2f7777772e74616c6c792e78797a2f676f762f656e732f70726f706f73616c2f35303436323931333332333836333134393632323739383439303436383330333935313035353433393435393930353437373635313636363437393633383332383530373038383135393639352920666f7220736572766963652070726f76696465722073656c656374696f6e20616e642074686520627564676574206672616d65776f726b2065737461626c697368656420696e205b455020362e335d2868747470733a2f2f7777772e74616c6c792e78797a2f676f762f656e732f70726f706f73616c2f3435383633363036343938393735333033303632393532373139303733303836363734363638303631333036363531363036383331323733393137373534353233343136353136343231303733292e0a0a546869732070726f706f73616c207472616e736974696f6e73206f7572206578697374696e672073747265616d696e6720696e6672617374727563747572652066726f6d207468652024332e364d20616e6e75616c2062756467657420737570706f7274696e6720392070726f76696465727320746f20746865206e65772024342e354d20616e6e75616c2062756467657420737570706f7274696e6720382070726f7669646572732c20696e636c7564696e67203620636f6e74696e75696e672070726f76696465727320616e642032206e6577206164646974696f6e732e0a0a23232053706563696669636174696f6e0a0a466f6c6c6f77696e67207468652073656c656374696f6e206f6620736572766963652070726f76696465727320696e20455020362e31302c20746869732070726f706f73616c20696d706c656d656e74732074686520746563686e6963616c206368616e67657320726571756972656420746f3a0a0a312e202a2a41646a7573742053747265616d696e6720496e6672617374727563747572652a2a202d2055706461746520746865206d617374657220666c6f7720726174652066726f6d20454e532044414f20746f207468652053747265616d204d616e6167656d656e7420506f6420746f206163636f6d6d6f646174652074686520696e63726561736564206275646765740a322e202a2a50726f7669646520496e697469616c2046756e64696e672a2a202d20537570706c79206f6e65206d6f6e7468206f6620555344432066756e64696e6720283337352c30303020555344432920746f20656e7375726520756e696e74657272757074656420736572766963650a332e202a2a436f6e666967757265204175746f7772617020506172616d65746572732a2a202d2053657420617070726f70726961746520616c6c6f77616e63657320666f72206175746f6d6174696320555344432d746f2d555344437820636f6e76657273696f6e0a0a5468652053747265616d204d616e6167656d656e7420506f642077696c6c20636f6e74696e756520746f206d616e61676520696e646976696475616c2070726f76696465722073747265616d732c2061646a757374696e6720726174657320666f7220636f6e74696e75696e672070726f76696465727320616e642065737461626c697368696e67206e65772073747265616d7320666f72204a757374614e616d6520616e64205a4b20456d61696c2e0a0a23232320536572766963652050726f766964657220416c6c6f636174696f6e730a0a54686520666f6c6c6f77696e672070726f76696465727320616e6420616c6c6f636174696f6e732068617665206265656e20617070726f7665643a0a0a7c20536572766963652050726f766964657220202020202020202020207c20416e6e75616c20416c6c6f636174696f6e207c2053747265616d204475726174696f6e207c0a7c202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d207c202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d207c202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d207c0a7c204554482e4c494d4f202020202020202020202020202020202020207c20243730302c303030202020202020202020207c20322079656172732020202020202020207c0a7c20426c6f636b66756c202020202020202020202020202020202020207c20243730302c303030202020202020202020207c20322079656172732020202020202020207c0a7c204e616d6568617368204c61627320202020202020202020202020207c2024312c3130302c30303020202020202020207c20312079656172202020202020202020207c0a7c20457468657265756d204964656e746974792050726f746f636f6c207c20243530302c303030202020202020202020207c20312079656172202020202020202020207c0a7c20556e7275676761626c6520202020202020202020202020202020207c20243430302c303030202020202020202020207c20312079656172202020202020202020207c0a7c204e616d6573706163652020202020202020202020202020202020207c20243430302c303030202020202020202020207c20312079656172202020202020202020207c0a7c205a4b20456d61696c202020202020202020202020202020202020207c20243430302c303030202020202020202020207c20312079656172202020202020202020207c0a7c204a757374616e616d652020202020202020202020202020202020207c20243330302c303030202020202020202020207c20312079656172202020202020202020207c0a7c202a2a546f74616c2a2a2020202020202020202020202020202020207c202a2a24342c3530302c3030302a2a202020207c20202020202020202020202020202020207c0a0a23232320546563686e6963616c20496d706c656d656e746174696f6e0a0a54686520696d706c656d656e746174696f6e206d61696e7461696e73206f7572206578697374696e67205375706572666c756964206172636869746563747572653a0a0a2a20454e53205472656173757279202854696d656c6f636b2920e286922053747265616d204d616e6167656d656e7420506f6420e2869220496e646976696475616c20536572766963652050726f7669646572730a2a205468652053747265616d204d616e6167656d656e7420506f6420636f6e74696e75657320746f20626520636f6e74726f6c6c65642062792033206f662035207369676e617475726573202833204d657461676f762053746577617264732c205365637265746172792c20616e642044414f20476f7665726e6f72290a2a205365637572697479206d656173757265732072656d61696e20696e20706c6163652c206c696d6974696e67206578706f7375726520746f20617070726f78696d6174656c792035302064617973206f662066756e64696e6720696e2063617365206f6620636f6e747261637420636f6d70726f6d6973650a0a2323205472616e73616374696f6e730a0a232323205472616e73616374696f6e20313a20417070726f76652055534443780a0a2a2a5461726765743a2a2a206030784130623836393931633632313862333663316431394434613265394562306345333630366542343860202855534443290a2a2a46756e6374696f6e3a2a2a2060617070726f7665600a2a2a417267756d656e74733a2a2a0a0a2a20607370656e6465723a20307831424138363033444137303236303241383635373938306538323541364441613033446565393361600a2a2060616d6f756e743a20333735303030303030303030600a0a2a2a43616c6c646174613a2a2a0a0a6060600a3078303935656137623330303030303030303030303030303030303030303030303031626138363033646137303236303261383635373938306538323561366461613033646565393361303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030353734666264653630300a6060600a0a2a2054656e6465726c793a205b417070726f76652055534443785d2868747470733a2f2f7777772e74646c792e636f2f7368617265642f73696d756c6174696f6e2f32323037636135302d363830342d346533332d626536312d343138316563643366386535290a0a232323205472616e73616374696f6e20323a2055706772616465205553444320746f2055534443780a0a2a2a5461726765743a2a2a20603078314241383630334441373032363032413836353739383065383235413644416130334465653933616020285553444378290a2a2a46756e6374696f6e3a2a2a206075706772616465600a2a2a417267756d656e74733a2a2a0a0a2a2060616d6f756e743a20333735303030303030303030303030303030303030303030600a0a2a2a43616c6c646174613a2a2a0a0a6060600a30783435393737643033303030303030303030303030303030303030303030303030303030303030303030303030303030303030303034663638636136643863643931633630303030300a6060600a0a2a2054656e6465726c793a205b5570677261646520555344435d2868747470733a2f2f7777772e74646c792e636f2f7368617265642f73696d756c6174696f6e2f36616266383231622d373739652d343239622d623864642d373037623731333630363837290a0a232323205472616e73616374696f6e20333a2053657420466c6f7720526174650a0a2a2a5461726765743a2a2a20603078636641313332453335336342344533393830383042393730303630396262303038656365423132356020285375706572666c756964290a2a2a46756e6374696f6e3a2a2a2060736574466c6f7772617465600a2a2a417267756d656e74733a2a2a0a0a2a2060746f6b656e3a20307831424138363033444137303236303241383635373938306538323541364441613033446565393361600a2a206072656365697665723a20307842313632426637413766443634654633326237383737313933333564303642323738306533314431600a2a2060666c6f77726174653a20313432353939343430373639333537353733600a0a2a2a43616c6c646174613a2a2a0a0a6060600a307835376536616133363030303030303030303030303030303030303030303030303162613836303364613730323630326138363537393830653832356136646161303364656539336130303030303030303030303030303030303030303030303062313632626637613766643634656633326237383737313933333564303662323738306533316431303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303166613964366639343361313730350a6060600a0a2a2054656e6465726c793a205b53657420466c6f7720526174655d2868747470733a2f2f7777772e74646c792e636f2f7368617265642f73696d756c6174696f6e2f39646433613730642d636563342d346661632d383863662d393336326664613137306663290a0a232323205472616e73616374696f6e20343a20536574204175746f7772617020416c6c6f77616e63650a0a2a2a5461726765743a2a2a206030784130623836393931633632313862333663316431394434613265394562306345333630366542343860202855534443290a2a2a46756e6374696f6e3a2a2a2060617070726f7665600a2a2a417267756d656e74733a2a2a0a0a2a20607370656e6465723a20307831443635633664334144333964343534456138463638326334396145373734343730366541393664600a2a2060616d6f756e743a2036333735303030303030303030600a0a2a2a43616c6c646174613a2a2a0a0a6060600a3078303935656137623330303030303030303030303030303030303030303030303031643635633664336164333964343534656138663638326334396165373734343730366561393664303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303030303035636334623963343630300a6060600a0a2a2054656e6465726c793a205b536574204175746f7772617020416c6c6f77616e63655d2868747470733a2f2f7777772e74646c792e636f2f7368617265642f73696d756c6174696f6e2f65313932656133312d313435632d346435302d393633322d313334323236376635623862290a2a0a0a232323205472616e73616374696f6e2044657461696c730a0a312e202a2a417070726f76652055534443782a2a3a20416c6c6f77732074686520555344437820636f6e747261637420746f207370656e64203337352c30303020555344432066726f6d2074686520454e532044414f20747265617375727920666f722074686520696e697469616c206d6f6e7468206f662066756e64696e670a322e202a2a55706772616465205553444320746f2055534443782a2a3a205772617073203337352c303030205553444320746f20555344437820285375706572666c75696427732073747265616d696e6720746f6b656e20666f726d6174290a332e202a2a53657420466c6f7720526174652a2a3a20496e6372656173657320746865206d61737465722073747265616d2066726f6d20302e31313431353532353131343135353235313220555344437820706572207365636f6e64202824332e364d2f796561722920746f20302e3134323539393434303736393335373537332055534443782f7365636f6e64202824342e354d2f79656172290a342e202a2a536574204175746f7772617020416c6c6f77616e63652a2a3a20417574686f72697a657320746865205375706572666c756964206175746f7772617070657220746f20636f6e7665727420757020746f20362e3337354d2055534443206f7665722074696d652c20656e737572696e6720636f6e74696e756f75732066756e64696e6720617661696c6162696c6974790a0a232320566572696669636174696f6e0a0a5468652074657374696e67207265706f7369746f727920776974682063616c63756c6174696f6e20746f6f6c7320616e6420766572696669636174696f6e207363726970747320697320617661696c61626c65206174205b6769746875622e636f6d2f35616a616b692f535050322d53747265616d735d2868747470733a2f2f6769746875622e636f6d2f35616a616b692f535050322d53747265616d73292e0a0a232320496d706c656d656e746174696f6e2054696d656c696e650a0a55706f6e2070617373616765206f6620746869732070726f706f73616c3a0a0a312e20546865207472616e73616374696f6e732077696c6c20626520657865637574656420696d6d6564696174656c790a322e205468652053747265616d204d616e6167656d656e7420506f642077696c6c20726563656976652074686520696e6372656173656420666c6f7720726174650a332e204d657461676f762073746577617264732077696c6c20636f6f7264696e617465207769746820736572766963652070726f76696465727320746f3a0a2020202a20557064617465206578697374696e672070726f76696465722073747265616d7320746f206e65772072617465730a2020202a2045737461626c6973682073747265616d7320666f72206e65772070726f76696465727320284a757374614e616d6520616e64205a4b20456d61696c290a2020202a2043616c63756c61746520616e64206469737472696275746520616e79206261636b6461746564207061796d656e747320666f72207261746520696e637265617365730a0a416c6c2070726f7669646572732077696c6c20636f6e74696e756520746f206265207375626a65637420746f20746865206578697374696e67204b594320616e642073616e6374696f6e7320636f6d706c69616e636520726571756972656d656e74732065737461626c697368656420696e20535050312e0a0a2a2a2a00000000000000000000000000000000000000000000000000000000";

    function _selectFork() public override {
        vm.createSelectFork({ blockNumber: 22_784_697, urlOrAlias: "mainnet" });
    }

    function _proposer() public pure override returns (address) {
        return 0xe52C39327FF7576bAEc3DBFeF0787bd62dB6d726; // 5pence.eth
    }

    function _beforeProposal() public override {
        // Check initial flow rate (should be lower than new rate)
        currentFlowRate = SUPERFLUID.getFlowrate(address(USDCx), address(timelock), streamPod);
        assertLt(currentFlowRate, NEW_FLOW_RATE);
        console2.log("current flow rate USDCx from timelock -> streamPod:", currentFlowRate);
        
        // Check USDCx balance before upgrade
        currentUSDCxBalanceTimelock = USDCx.balanceOf(address(timelock));
        console2.log("current USDCx balance on timelock:", currentUSDCxBalanceTimelock/1e18);
        
        // current USDC approval for USDCx
        currentUSDCApproval = USDC.allowance(address(timelock), address(USDCx));
        console2.log("current USDC approval from timelock -> USDCx:", currentUSDCApproval/1e6);
        
        // current USDCx balance on streamPod
        currentUSDCxBalanceStreamPod = USDCx.balanceOf(address(streamPod));
        console2.log("current USDCx balance on streamPod:", currentUSDCxBalanceStreamPod/1e18);
        console2.log("timestamp:", block.timestamp);

        // current Autowrap allowance
        currentAutowrapAllowance = USDC.allowance(address(timelock), autowrapper);
        console2.log("current USDC approval timelock -> autowrapper:", currentAutowrapAllowance/1e6);
    }

    function _generateCallData()
        public
        override
        returns (
            address[] memory,
            uint256[] memory,
            string[] memory,
            bytes[] memory,
            string memory
        )
    {
        (,,,description) =
            abi.decode(proposalCalldata, (address[], uint256[], bytes[], string));

        // Transaction 1: Approve USDCx contract to spend USDC for upgrade
        address[] memory internalTargets = new address[](4);
        uint256[] memory internalValues = new uint256[](4);
        bytes[] memory internalCalldatas = new bytes[](4);
        string[] memory internalSignatures = new string[](4);

        // Transaction 1: Approve USDCx contract to spend USDC for upgrade
        internalTargets[0] = address(USDC);
        internalValues[0] = 0;
        internalSignatures[0] = "";
        internalCalldatas[0] = abi.encodeWithSelector(
            IERC20.approve.selector,
            address(USDCx), // spender: USDCx contract
            INITIAL_USDC_AMOUNT // amount: 375,000 USDC
        );

        // Transaction 2: Upgrade USDC to USDCx
        internalTargets[1] = address(USDCx);
        internalValues[1] = 0;
        internalSignatures[1] = "";
        internalCalldatas[1] = abi.encodeWithSelector(
            IUSDCx.upgrade.selector,
            UPGRADE_AMOUNT // amount: 375,000 USDCx
        );

        // Transaction 3: Set new flow rate via Superfluid
        internalTargets[2] = address(SUPERFLUID);
        internalValues[2] = 0;
        internalSignatures[2] = "";
        internalCalldatas[2] = abi.encodeWithSelector(
            CFAv1Forwarder.setFlowrate.selector,
            address(USDCx), // token: USDCx
            streamPod, // stream pod
            NEW_FLOW_RATE // flowrate: ~$4.5M/year
        );

        // Transaction 4: Set autowrap allowance
        internalTargets[3] = address(USDC);
        internalValues[3] = 0;
        internalSignatures[3] = "";
        internalCalldatas[3] = abi.encodeWithSelector(
            IERC20.approve.selector,
            autowrapper, // spender: autowrapper
            AUTOWRAP_ALLOWANCE // amount: 6.375M USDC
        );

        return (internalTargets, internalValues, internalSignatures, internalCalldatas, description);
    }

    function _afterExecution() public override {
        // New flow rate
        int96 newFlowRate = SUPERFLUID.getFlowrate(address(USDCx), address(timelock), streamPod);
        console2.log("new flow rate USDCx from timelock -> streamPod:", newFlowRate);

        // Validate flowrate
        assertEq(newFlowRate, NEW_FLOW_RATE);
        
        // Check USDCx balance before upgrade
        uint256 newUSDCxBalanceTimelock = USDCx.balanceOf(address(timelock));
        console2.log("new USDCx balance on timelock:", newUSDCxBalanceTimelock/1e18);
        
        // Validate USDCx balance on timelock was increased
        assertGt(newUSDCxBalanceTimelock, currentUSDCxBalanceTimelock);
        
        // new USDC approval for USDCx
        uint256 newUSDCApproval = USDC.allowance(address(timelock), address(USDCx));
        console2.log("new USDC approval from timelock -> USDCx:", newUSDCApproval/1e6);
        
        uint256 newUSDCxBalanceStreamPod = USDCx.balanceOf(address(streamPod));
        console2.log("new USDCx balance on streamPod:", newUSDCxBalanceStreamPod/1e18);
        console2.log("timestamp:", block.timestamp);

        // new Autowrap allowance
        uint256 newAutowrapAllowance = USDC.allowance(address(timelock), autowrapper);
        console2.log("new USDC approval timelock -> autowrapper:", newAutowrapAllowance/1e6);
        
        // Validate USDC approval on autowrapper was set to $6.375M
        assertEq(newAutowrapAllowance, AUTOWRAP_ALLOWANCE);

    }

    function _isProposalSubmitted() public pure override returns (bool) {
        return true; // Proposal exists with the given ID
    }
}

