// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

import { Test } from "@forge-std/src/Test.sol";
import { console2 } from "@forge-std/src/console2.sol";

import { IERC20 } from "@contracts/utils/interfaces/IERC20.sol";
import { ENS_Governance } from "@ens/ens.t.sol";

contract Proposal_ENS_EP_6_2_Test is ENS_Governance {
    uint256 USDCbalanceBefore;
    uint256 ENSbalanceBefore;
    uint256 expectedUSDCtransfer = (589_000 + 356_000) * 10 ** 6;
    uint256 expectedENStransfer = 100_000 ether;

    IERC20 public usdcToken = IERC20(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48);

    bytes proposalCalldata =
        hex"00000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000018000000000000000000000000000000000000000000000000000000000000003800000000000000000000000000000000000000000000000000000000000000003000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c18360217d8f7ab5e7c516566761ea12ce7f9d72000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb4800000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001600000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000091c32893216de3ea0a55abb9851f581d4503d39b000000000000000000000000000000000000000000000000000000892322c200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000091c32893216de3ea0a55abb9851f581d4503d39b00000000000000000000000000000000000000000000152d02c7e14af6800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb000000000000000000000000cd42b4c4d102cc22864e3a1341bb0529c17fd87d00000000000000000000000000000000000000000000000000000052e340e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c2723205b455020362e31315d205b45786563757461626c655d20436f6c6c65637469766520576f726b696e672047726f75702046756e64696e6720526571756573742028417072696c2032303235290a7c2053746174757320202020207c20447261667420202020202020202020202020202020202020202020202020202020202020202020202020202020202020207c0a7c202d2d2d2d2d2d2d2d2d2d207c202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d207c0a7c202a2a417574686f722a2a207c205b3570656e63652e6574685d2868747470733a2f2f6170702e656e732e646f6d61696e732f3570656e63652e65746829207c0a0a23232041627374726163740a0a546869732070726f706f73616c2065786563757465732066756e64696e6720726571756573747320666f7220746865204d6574612d476f7665726e616e636520616e64205075626c696320476f6f647320576f726b696e672047726f75707320666f722074686520417072696c20323032352066756e64696e672077696e646f772061732070617373656420696e205b455020362e362e315d2868747470733a2f2f646973637573732e656e732e646f6d61696e732f742f362d362d312d736f6369616c2d617072696c2d66756e64696e672d726571756573742d656e732d6d6574612d676f7665726e616e63652d776f726b696e672d67726f75702d7465726d2d362f32303533362920616e64205b455020362e362e325d2868747470733a2f2f646973637573732e656e732e646f6d61696e732f742f362d362d322d736f6369616c2d617072696c2d66756e64696e672d726571756573742d656e732d7075626c69632d676f6f64732d776f726b696e672d67726f75702d7465726d2d362f3230353332292e20546869732062756e646c65642065786563757461626c652070726f706f73616c20666f6c6c6f77732074686520726571756972656d656e747320736574206f757420696e2052756c652031302e31206f662074686520576f726b696e672047726f75702052756c657320285b455020312e385d2868747470733a2f2f646f63732e656e732e646f6d61696e732f64616f2f70726f706f73616c732f312e382f29292e0a0a23232050726f706f73616c20436f6d706f6e656e74730a0a2a2a2a0a0a232323203129205b4d6574612d676f7665726e616e63652046756e64696e672052657175657374205c5b455020362e362e315c5d5d2868747470733a2f2f646973637573732e656e732e646f6d61696e732f742f362d362d312d736f6369616c2d617072696c2d66756e64696e672d726571756573742d656e732d6d6574612d676f7665726e616e63652d776f726b696e672d67726f75702d7465726d2d362f3230353336290a0a546865204d6574612d476f7665726e616e636520576f726b696e672047726f75702072657175657374732066756e64696e6720746f2066756c66696c6c20616e74696369706174656420627564676574617279206e65656473207468726f75676820746865206e65787420666f726d616c2066756e64696e672077696e646f7720696e204f63746f62657220323032352e0a0a7c2044657374696e6174696f6e202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020207c2055534443202020207c20455448207c2024454e53202020207c0a7c202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d207c202d2d2d2d2d2d2d207c202d2d2d207c202d2d2d2d2d2d2d207c0a7c205b454e53204d6574612d476f76204d61696e204d756c74697369675d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f30783931633332383933323136644533654130613535414262393835316635383164343530336433396229207c203538392c303030207c20302020207c203130302c303030207c0a0a5468697320616d6f756e742077696c6c20636f76657220616c6c20657870656374656420657870656e736573206f75746c696e656420696e2074686520736f6369616c2070726f706f73616c207768696c65206c656176696e6720612070727564656e74207265736572766520746f20656e7375726520636f6e74696e75697479206966206675747572652066756e64696e672069732064656c617965642e0a0a2a2a2a0a0a232323203229205b5075626c696320476f6f64732046756e64696e672052657175657374205c5b455020362e362e325c5d5d2868747470733a2f2f646973637573732e656e732e646f6d61696e732f742f362d362d322d736f6369616c2d617072696c2d66756e64696e672d726571756573742d656e732d7075626c69632d676f6f64732d776f726b696e672d67726f75702d7465726d2d362f3230353332290a0a54686520454e53205075626c696320476f6f647320576f726b696e672047726f75702072657175657374732066756e64696e6720746f20737570706f7274206f7065726174696f6e73207468726f75676820746865206e65787420666f726d616c2066756e64696e672077696e646f7720696e204f63746f62657220323032352e0a0a7c2044657374696e6174696f6e202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020202020207c2055534443202020207c20455448207c2024454e53207c0a7c202d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d2d207c202d2d2d2d2d2d2d207c202d2d2d207c202d2d2d2d207c0a7c205b454e53205047204d61696e204d756c74697369675d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f30786344343262346334443130326363323238363465334131333431426230353239633137664438376429207c203335362c303030207c20302020207c2030202020207c0a0a5468697320616d6f756e7420726570726573656e7473207468652061646a75737465642066756e64696e6720726571756573742061667465722064697363757373696f6e7320696e2074686520666f72756d2c207265647563696e6720746865206f726967696e616c20726571756573742066726f6d203532316b20746f203335366b2062792061646a757374696e672074686520537472617465676963204772616e747320616e642064697363726574696f6e6172792066756e64696e672063617465676f726965732e0a0a2a2a2a0a0a23232053706563696669636174696f6e0a0a54686520666f6c6c6f77696e67207472616e73666572732061726520746f206265206d6164652066726f6d207468652044414f2074726561737572793a0a0a312e205472616e73666572203538392c303030205553444320746f20746865204d6574612d676f7665726e616e636520736166653a0a2020202a20416464726573733a2060307839316333323839333231366445336541306135354142623938353166353831643435303364333962600a322e205472616e73666572203130302c30303020454e5320746f20746865204d6574612d676f7665726e616e636520736166653a0a2020202a20416464726573733a2060307839316333323839333231366445336541306135354142623938353166353831643435303364333962600a332e205472616e73666572203335362c303030205553444320746f20746865205075626c696320476f6f647320736166653a0a2020202a20416464726573733a2060307863443432623463344431303263633232383634653341313334314262303532396331376644383764600a0a2323232320546f74616c207472616e7366657220616d6f756e743a203934352c303030205553444320616e64203130302c30303020454e530a0a2a2a2a0a0a23232300000000000000000000000000000000000000000000000000";

    function _proposer() public pure override returns (address) {
        return 0xe52C39327FF7576bAEc3DBFeF0787bd62dB6d726; // 5pence.eth
    }

    function _beforeExecution() public override {
        USDCbalanceBefore = usdcToken.balanceOf(address(timelock));
        ENSbalanceBefore = ensToken.balanceOf(address(timelock));
    }

    function _generateCallData()
        public
        override
        returns (address[] memory, uint256[] memory, string[] memory, bytes[] memory, string memory)
    {
        (targets, values, calldatas, description) =
            abi.decode(proposalCalldata, (address[], uint256[], bytes[], string));

        address[] memory targets = new address[](3);
        targets[0] = address(usdcToken);
        targets[1] = address(ensToken);
        targets[2] = address(usdcToken);

        bytes[] memory internalCalldatas = new bytes[](3);
        internalCalldatas[0] = abi.encodeWithSelector(
            IERC20.transfer.selector, 0x91c32893216dE3eA0a55ABb9851f581d4503d39b, 589_000 * 10 ** 6
        );
        internalCalldatas[1] = abi.encodeWithSelector(
            IERC20.transfer.selector, 0x91c32893216dE3eA0a55ABb9851f581d4503d39b, expectedENStransfer
        );
        internalCalldatas[2] = abi.encodeWithSelector(
            IERC20.transfer.selector, 0xcD42b4c4D102cc22864e3A1341Bb0529c17fD87d, 356_000 * 10 ** 6
        );

        assertEq(calldatas, internalCalldatas);

        bytes memory expectedCalldata = abi.encode(targets, values, internalCalldatas, description);
        assertEq(proposalCalldata, expectedCalldata);

        return (targets, new uint256[](3), new string[](1), calldatas, "");
    }

    function _afterExecution() public view override {
        uint256 USDCbalanceAfter = usdcToken.balanceOf(address(timelock));
        assertEq(USDCbalanceAfter, USDCbalanceBefore - expectedUSDCtransfer);

        uint256 ENSbalanceAfter = ensToken.balanceOf(address(timelock));
        assertEq(ENSbalanceAfter, ENSbalanceBefore - expectedENStransfer);
    }

    function _isProposalSubmitted() public pure override returns (bool) {
        return false;
    }
}
