// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

import { Test } from "@forge-std/src/Test.sol";
import { console2 } from "@forge-std/src/console2.sol";

import { IToken } from "@ens/interfaces/IToken.sol";
import { IGovernor } from "@ens/interfaces/IGovernor.sol";
import { ITimelock } from "@ens/interfaces/ITimelock.sol";
import { IERC20 } from "@contracts/utils/interfaces/IERC20.sol";

import { ENS_Governance } from "@ens/ens.t.sol";

interface IWithdraw {
    function withdraw() external;
}

contract Proposal_ENS_EP_6_1_Test is ENS_Governance {
    IWithdraw OldRegistrarController = IWithdraw(0x283Af0B28c62C092C9727F1Ee09c02CA627EB7F5);

    uint256 ETHbalanceBeforeRegistrar;

    uint256 ETHbalanceBeforeTimelock;
    uint256 expectedETHtransferTimelock = 6000 * 10 ** 18;

    address receiver = 0x02D61347e5c6EA5604f3f814C5b5498421cEBdEB; // TWAP Safe

    bytes proposalCalldata =
        hex"000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e000000000000000000000000000000000000000000000000000000000000001400000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000000200000000000000000000000002d61347e5c6ea5604f3f814c5b5498421cebdeb000000000000000000000000283af0b28c62c092c9727f1ee09c02ca627eb7f5000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000014542ba12a337c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000043ccfd60b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000104423205b4550362e315d205b45786563757461626c655d20436f6e7665727420362c3030302045544820746f205553444320666f722044414f204f7065726174696e6720457870656e7365730a0a232041627374726163740a0a57652070726f706f736520746f20636f6e7665727420362c3030302045544820696e746f205553444320746f207265706c656e69736820746865205553444320726573657276657320696e20746865205b44414fe28099732074726561737572795d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f307866653839636337616262326334313833363833616237313635336334636463396230326434346237292e0a0a0a23204d6f7469766174696f6e0a0a496e20466562727561727920323032332c207468652044414f20657865637574656420612073776170206f662031302c3030302045544820696e746f205553444320766961205b455020332e335d2868747470733a2f2f7777772e74616c6c792e78797a2f676f762f656e732f70726f706f73616c2f3435343631393033303738393438313331383730303531313332303831323439383932303039343937373039353138343133373434393538353531383839323137383035383237333031343235292c2067656e65726174696e6720617070726f78696d6174656c79202431362e324d20696e20555344432e2054686520726174696f6e616c65206174207468652074696d652077617320746f20736563757265203138e280933234206d6f6e746873206f66206f7065726174696f6e616c2072756e7761792e0a0a4f766572207468652070617374203231206d6f6e7468732c2074686520555344432072657365727665732068617665206265656e206566666563746976656c79207574696c6973656420746f2066756e6420454e532044414fe2809973206f7065726174696f6e732e20486f77657665722c2074686573652072657365727665732068617665206e6f77206265656e2066756c6c79206465706c657465642e20546f20656e737572652066696e616e6369616c2073746162696c69747920616e6420656666656374697665206c6971756964697479206d616e6167656d656e742c2069742069732070727564656e7420746f2073656375726520612031322d6d6f6e74682072756e77617920696e207468652044414fe28099732077616c6c657420746f20636f766572206f7065726174696e6720657870656e7365732e0a0a57652070726f706f736520454e5320636f6e7665727420362c3030302045544820287e2432302e344d2061742024332c3230302f4554482920746f207265706c656e6973682074686520555344432072657365727665732e2054686573652066756e64732077696c6c206265207573656420746f206d656574206f6e676f696e6720636f6d6d69746d656e74732c2073756368206173207061796d656e747320746f205b454e53204c6162735d2868747470733a2f2f646973637573732e656e732e646f6d61696e732f742f65702d352d32322d656e7376322d646576656c6f706d656e742d66756e64696e672d726571756573742f3139373632292c20616e64205b536572766963652050726f76696465722073747265616d735d2868747470733a2f2f646f63732e656e732e646f6d61696e732f64616f2f70726f706f73616c732f352e322920616e642044414f20576f726b696e672047726f7570732e0a0a0a232053706563696669636174696f6e200a0a5468652065786563757461626c652070726f706f73616c2077696c6c207472616e7366657220362c303030204554482066726f6d2074686520454e532044414f2057616c6c657420746f2061205b6e657720536166655d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f30783032443631333437653563364541353630346633663831344335623534393834323163454264454229206372656174656420736f6c656c7920666f72207468652073776170206f662045544820746f20555344432e205468652070726f706f73616c2077696c6c20616c736f20737765657020746865204554482062616c616e636520696e20746865205b4f6c642052656769737472617220436f6e74726f6c6c6572205d2868747470733a2f2f646562616e6b2e636f6d2f70726f66696c652f30783238336166306232386336326330393263393732376631656530396330326361363237656237663529746f207468652044414f2077616c6c65742e0a0a546865207061796c6f616420746f207472616e7366657220366b204554482066726f6d207468652044414f204d756c746973696720697320617661696c61626c65205b686572655d2868747470733a2f2f676973742e6769746875622e636f6d2f4a65726f6e696d6f486f756c696e2f3565343732386433366266356432623765653038623933383266363162663738292e205472616e73616374696f6e2064657461696c733a0a0a0a0a2a2046726f6d3a20454e532044414f2057616c6c657420285b77616c6c65742e656e7364616f2e6574685d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f307846653839636337614242324334313833363833616237313635334334636463394230324434346237236d756c7469636861696e2d706f7274666f6c696f29290a2a20546f6b656e3a204554480a2a20416d6f756e743a20362c3030300a2a20526563697069656e743a2054574150205361666520285b307830324436e280a6426445425d2868747470733a2f2f6170702e736166652e676c6f62616c2f686f6d653f736166653d6574683a30783032443631333437653563364541353630346633663831344335623534393834323163454264454229290a0a6b61727061746b657920686173206465706c6f7965642061205b6e657720536166655d2868747470733a2f2f6170702e736166652e676c6f62616c2f686f6d653f736166653d6574683a307830324436313334376535633645413536303466336638313443356235343938343231634542644542292064656469636174656420736f6c656c7920666f722054574150732c2077697468206b61727061746b657920616e6420454e5320726570726573656e74617469766573206173207369676e6572732e205468652053616665206861732061207468726573686f6c64206f662033207369676e61747572657320616e642074686520666f6c6c6f77696e67207369676e6572733a0a0a0a0a312e2044414f2057616c6c657420285b77616c6c65742e656e7364616f2e6574685d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f30786665383963633761626232633431383336383361623731363533633463646339623032643434623729290a322e206b61727061746b6579e280997320456e646f776d656e74206d616e61676572205361666520285b3078623432336530663645373433306661323935303063356343396264383344323863384244383937385d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f30786234323365306636453734333066613239353030633563433962643833443238633842443839373829290a332e20454e53204c616273e2809920636f6c642077616c6c657420285b636f6c6477616c6c65742e656e732e6574685d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f30783639304630353831654365634366383338396332323331373037373863443944303239363036463229290a342e204d657461676f7620576f726b696e672047726f7570205361666520285b6d61696e2e6d672e77672e656e732e6574685d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f3078393163333238393332313664453365413061353541426239383531663538316434353033643339622929200a0a5468697320616c6c6f777320666f7220746865207365677265676174696f6e206f662066756e6473206265747765656e206f7468657220454e532d72656c617465642077616c6c6574732028652e672e2074686520456e646f776d656e742053616665292e20546869732070726f706f73616c2073656e647320362c3030302045544820746f20746865206e65776c79206372656174656420536166652e0a0a5369676e6572732077696c6c20737761702045544820746f20555344432076696120436f77e28099732054574150206d656368616e69736d2e200a0a54686520726174696f6e616c6520626568696e642074686973206672616d65776f726b2069732074686174205b436f77e280997320545741502066756e6374696f6e5d2868747470733a2f2f646f63732e636f772e66692f636f772d70726f746f636f6c2f7265666572656e63652f636f6e7472616374732f70726f6772616d6d617469632f74776170292069732063757272656e746c79206e6f7420737570706f727465642062792054616c6c79206f7220746865205a6f6469616320526f6c6573204d6f64696669657220285a524d29207065726d697373696f6e732e204f6e63652054574150207065726d697373696f6e732061726520696e74656772617465642c205a524d2063616e206265206f6e626f617264656420746f207468697320536166652c20616c6c6f77696e6720666f72207468652072656d6f76616c206f662074686520454e53207369676e6572732e0a0a53616665206b6579686f6c646572732077696c6c20657865637574652074686520666f6c6c6f77696e672073776170733a0a0a0a0a312e20312c30303020455448207377617020746f206d65657420696d6d6564696174652066756e64696e67206e656564732062792074686520454e532044414f2c20657865637574656420617320736f6f6e2061732066756e6473206265636f6d6520617661696c61626c652e0a322e20352c30303020455448207377617020766961206120332d6d6f6e746820545741502c20636f6e64756374656420696e20393020706172747320287e35352e362045544820736f6c64207065722070617274292c20776974682077616c6c65742e656e7364616f2e65746820617320726563697069656e742e200a0a546865207061796c6f616420746f2063616c6c2077697468647261772829206f6e20746865204f6c642052656769737472617220436f6e74726f6c6c65722c20616e642073656e64207468652066756e647320746f207468652044414f204d756c74697369672c20697320617661696c61626c65205b686572655d2868747470733a2f2f676973742e6769746875622e636f6d2f4a65726f6e696d6f486f756c696e2f6630386537613537303438323964663630363630326535333434373536396533292e0a0a5472616e73616374696f6e2064657461696c733a0a0a0a0a2a2046726f6d3a204f6c642052656769737472617220436f6e74726f6c6c65722028307832383361663062323863363263303932633937323766316565303963303263613632376562376635290a2a20546f6b656e3a204554480a2a20416d6f756e743a20342c3234312e3936362028746f74616c2062616c616e6365290a2a20526563697069656e743a20454e532044414f2057616c6c6574202877616c6c65742e656e7364616f2e6574682900000000000000000000000000000000000000000000000000000000";

    function _selectFork() public override {
        vm.createSelectFork({ blockNumber: 21_723_989, urlOrAlias: "mainnet" });
    }

    function _proposer() public pure override returns (address) {
        return 0xb8c2C29ee19D8307cb7255e1Cd9CbDE883A267d5; // nick.eth
    }

    function _beforeProposal() public override {
        ETHbalanceBeforeTimelock = address(timelock).balance;
        ETHbalanceBeforeRegistrar = address(OldRegistrarController).balance;
    }

    function _generateCallData()
        public
        override
        returns (address[] memory, uint256[] memory, string[] memory, bytes[] memory, string memory)
    {
        (targets, values, calldatas, description) =
            abi.decode(proposalCalldata, (address[], uint256[], bytes[], string));

        bytes[] memory internalCalldatas = new bytes[](2);
        internalCalldatas[0] = new bytes(0);
        internalCalldatas[1] = abi.encodeWithSelector(OldRegistrarController.withdraw.selector);

        bytes memory expectedCalldata = abi.encode(targets, values, internalCalldatas, description);

        assertEq(calldatas, internalCalldatas);
        assertEq(proposalCalldata, expectedCalldata);

        return (targets, values, signatures, calldatas, description);
    }

    function _afterExecution() public view override {
        uint256 ETHbalanceAfterTimelock = address(timelock).balance;

        assertEq(
            ETHbalanceAfterTimelock, ETHbalanceBeforeTimelock + ETHbalanceBeforeRegistrar - expectedETHtransferTimelock
        );

        uint256 safeBalance = receiver.balance;
        assertEq(safeBalance, expectedETHtransferTimelock);

        uint256 registrarBalance = address(OldRegistrarController).balance;
        assertEq(registrarBalance, 0);
    }

    function _isProposalSubmitted() public pure override returns (bool) {
        return true;
    }
}
