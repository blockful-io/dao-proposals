// SPDX-License-Identifier: MIT
pragma solidity ^0.8.13;

import { Test } from "@forge-std/src/Test.sol";
import { console2 } from "@forge-std/src/console2.sol";

import { IToken } from "@ens/interfaces/IToken.sol";
import { IGovernor } from "@ens/interfaces/IGovernor.sol";
import { ITimelock } from "@ens/interfaces/ITimelock.sol";
import { IERC20 } from "@contracts/utils/interfaces/IERC20.sol";

import { ENS_Governance } from "@ens/ens.t.sol";

contract Proposal_ENS_EP_5_23_Test is ENS_Governance {
    IERC20 USDC = IERC20(0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48);
    IERC20 ENS = IERC20(0xC18360217D8F7Ab5e7c516566761Ea12Ce7F9D72);

    uint256 USDCbalanceBefore;
    uint256 expectedUSDCtransfer = 100_000 * 10 ** 6; // USDC decimals
    uint256 USDCbalanceAfter;

    uint256 ENSbalanceBefore;
    uint256 expectedENStransfer = 15_000 * 10 ** 18; // ENS decimals
    uint256 ENSbalanceAfter;

    address receiver = 0x91c32893216dE3eA0a55ABb9851f581d4503d39b;

    bytes proposalCalldata = hex"000000000000000000000000000000000000000000000000000000000000008000000000000000000000000000000000000000000000000000000000000000e0000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000002a00000000000000000000000000000000000000000000000000000000000000002000000000000000000000000a0b86991c6218b36c1d19d4a2e9eb0ce3606eb48000000000000000000000000c18360217d8f7ab5e7c516566761ea12ce7f9d720000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000c00000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000091c32893216de3ea0a55abb9851f581d4503d39b000000000000000000000000000000000000000000000000000000174876e800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000044a9059cbb00000000000000000000000091c32893216de3ea0a55abb9851f581d4503d39b00000000000000000000000000000000000000000000032d26d12e980b6000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012ea23205b455020352e32335d205b45786563757461626c655d20626c6f636b66756c277320676f7665726e616e636520736563757269747920626f756e74790a23232053756d6d6172790a0a0a0a546869732070726f706f73616c2061696d7320746f20636f6d70656e736174652074686520626c6f636b66756c207465616d20666f7220746865697220776f726b20696e206964656e74696679696e672c20616e616c797a696e672c207265706f7274696e6720616e64206d697469676174696e672061207365766572652076756c6e65726162696c69747920696e20454e532044414f277320676f7665726e616e6365207374727563747572652e0a0a0a0a2323204261636b67726f756e640a0a0a0a496e204d6172636820323032342c20626c6f636b66756c20756e636f7665726564206120637269746963616c2076756c6e65726162696c697479207468617420636f756c642068617665206c656420746f2061205b7e243135304d5d2868747470733a2f2f64756e652e636f6d2f737465616b686f7573652f656e732d737465616b686f7573652920746865667420616e642070726f746f636f6c20636170747572652e2054686569722073756273657175656e7420776f726b206c656420746f2074686520696d706c656d656e746174696f6e206f662074686520536563757269747920436f756e63696c2c207369676e69666963616e746c7920656e68616e63696e6720454e532044414f277320726573696c69656e636520616761696e73742061747461636b732e0a0a0a0a232320436f6e747269627574696f6e2044657461696c730a0a0a0a546865207465616d20696e766f6c7665642069732061205b646966666572656e745d2868747470733a2f2f646973637573732e656e732e646f6d61696e732f742f626c6f636b66756c2d736572766963652d70726f76696465722d7265706f7274732f313935353323702d35343136332d6f746865722d636f6e747269627574696f6e732d6e6f742d72656c617465642d746f2d736572766963652d70726f76696465722d73636f70652d313429207371756164207468616e20746865206f6e6520776f726b696e67206f6e207468652073636f7065206f6620746865205b454e5320736572766963652070726f76696465725d2868747470733a2f2f646973637573732e656e732e646f6d61696e732f742f626c6f636b66756c2d736572766963652d70726f76696465722d7265706f7274732f3139353533292e2049742077617320646576656c6f70656420627920322072657365617263686572732c203120736d61727420636f6e747261637420656e67696e65657220616e64203420646966666572656e742061756469746f727320746865207465616d2068617320776f726b656420776974682070726576696f75736c792e2053756d6d696e6720757020746f207e36303020686f7572732c207468652073636f706520696e636c756465733a0a0a2a20436f6d70726568656e736976652076756c6e65726162696c697479206173736573736d656e7420616e64207269736b20616e616c797369733a202a2a5b486572655d2868747470733a2f2f6d6972726f722e78797a2f72657365617263682e626c6f636b66756c2e6574682f2d50664d6475687078647970507275746f6672363039395434524f7073416d583066504e62764467525c5f6b292a2a206973206f75722064657461696c6564207365637572697479207265706f72742e0a0a2a204461746120616e616c79736973206f6620454e5320676f7665726e616e6365206d65747269637320616e64207374756479206f6620706173742044414f2061747461636b65722773206265686176696f72732e0a0a2a2044657369676e2c20646576656c6f706d656e7420616e64206465706c6f796d656e74206f662074686520536563757269747920436f756e63696c20636f6e747261637420616e64206d756c74697369672e0a0a2a2054686520536563757269747920436f756e63696c207761732074686f756768742077697468207365766572616c206b657920666561747572657320746f2062616c616e636520736563757269747920616e6420646563656e7472616c697a6174696f6e2e0a0a2a20536d61727420636f6e747261637420696d706c656d656e746174696f6e20616e642074657374696e6720285b4769744875625d2868747470733a2f2f6769746875622e636f6d2f626c6f636b66756c2d696f2f73656375726974792d636f756e63696c2d656e7329290a0a2a20476f7665726e616e63652070726f706f73616c206472616674696e6720616e6420737570706f7274205b5b315d2868747470733a2f2f736e617073686f742e6f72672f232f656e732e6574682f70726f706f73616c2f307866336134363733666530346133656366656434613266303636663663656431353339613534363664363136333034323833333333363062383433363533633534292c205b325d2868747470733a2f2f736e617073686f742e6f72672f232f656e732e6574682f70726f706f73616c2f307861306231626661646636383533623562306435396433633464373363343334666336333839333339383837643035646538303533363133373265623137633361292c205b335d2868747470733a2f2f7777772e74616c6c792e78797a2f676f762f656e732f70726f706f73616c2f3432333239313033373937343333373737333039343838303432303239363739383131383032313732333230393739353431343134363833333030313833323733333736383339323139313333295d0a0a0a0a4d6f72652064657461696c732063616e20626520666f756e64206f6e20746865206c696e6b732061626f766520666f7220706173742070726f706f73616c7320616e6420746865205b7265706f72745d2868747470733a2f2f6d6972726f722e78797a2f72657365617263682e626c6f636b66756c2e6574682f2d50664d6475687078647970507275746f6672363039395434524f7073416d583066504e62764467525c5f6b292e0a0a0a0a232320436f6d70656e736174696f6e20526174696f6e616c650a0a0a0a26237832303b41732061207465616d207468617420697320746f74616c6c7920626f6f74737472617070656420616e64206e6576657220726563656976656420616e7920696e766573746d656e742c207468697320737570706f727420757320746f206b656570206974207375737461696e61626c65207769746820746865207265736f757263657320696e76657374656420746f7761726473207468697320696e69746961746976652e205468652072657175657374656420616d6f756e7420726570726573656e7473206661697220636f6d70656e736174696f6e20666f723a0a0a0a0a2a2054686520706f74656e7469616c206c6f73732070726576656e74696f6e206f66207e243135304d2c2063617074757265206f66207468652044414f20616e642070726f746f636f6c2e205468652061747461636b20697320616e797468696e6720627574207468656f7265746963616c20616e64207468657265206172652061637475616c6c79206d616e792067726f757073206f6620696e766573746f72732077686f207370656369616c697a6520696e20227269736b20667265652076616c75652072616964657273222e205468657920686176652065786572746564207468652061747461636b206f6e206f746865722044414f73206265666f72652e2043757272656e746c7920746865726520617265205b756e6b6e6f776e207768616c65735d2868747470733a2f2f65746865727363616e2e696f2f616464726573732f30783234353434353934306233313765353039303032656236383265303366343432393138343035396423746f6b656e74786e732920627579696e6720454e5320666f72202b343530206461797320616e642068617665207e324d20454e532c2073686f77696e6720686f77206665617369626c6520746865207363656e6172696f2069732c206d6f7265207468616e2074686520617665726167652071756f72756d2c20696e206f6e652077616c6c65742e0a0a2a204120637269746963616c20636f64652062756720626f756e747920696e205b454e5320697320243235306b20555344435d2868747470733a2f2f696d6d756e6566692e636f6d2f6275672d626f756e74792f656e732f73636f70652f23617373657473292e204f757220776f726b20776173206d756368206265796f6e64206964656e74696679696e6720616e6420646973636c6f73696e672e0a0a2a205369676e69666963616e746c79206c6f77657220636f737420636f6d706172656420746f207374616e646172642072617465732063686172676564206279206f7468657220736563757269747920736572766963652070726f76696465727320696e207468652044414f2073706163652c207768696368207479706963616c6c792064656d616e64206c697175696420636f6d70656e736174696f6e2e20416e206578616d706c652069732074686174204f70656e205a657070656c696e20286f6e65206f6620746865206d6f737420726570757461626c6520706c617965727320696e20736563757269747929205b636861726765732024344d2f7965617220617420436f6d706f756e645d2868747470733a2f2f636f6d706f756e642e66696e616e63652f676f7665726e616e63652f70726f706f73616c732f3736292c20776869636820726563656e746c79205b73756666657265645d2868747470733a2f2f6d6972726f722e78797a2f72657365617263682e626c6f636b66756c2e6574682f763047455034396f585031677a4d446c795039312d53345849613850494f6430764b712d365238663534492920746869732074797065206f662061747461636b2e0a0a2a204d6f6e746873206f662064656469636174656420776f726b20627920746865207465616d20696e766f6c766564202872657365617263686572732c206465767320616e642061756469746f7273292e0a0a2a20546865206c6f6e672d7465726d2076616c756520616464656420746f20454e53207468726f75676820656e68616e6365642073656375726974792e0a0a2a204f757220636f6d6d69746d656e7420746f20454e532773206c6f6e672d7465726d207375636365737320616e6420636f6e74696e75656420636f6e747269627574696f6e2c2061732065766964656e6365642062792074686520322d796561722076657374696e67207363686564756c652e0a0a0a0a232320436f6d70656e736174696f6e205374727563747572650a0a0a0a2a20546f74616c20616d6f756e743a203130306b2055534443202b2031356b2076657374656420454e5320746f6b656e730a0a2a2056657374696e6720706572696f643a20322079656172730a0a2a2056657374696e6720737461727420646174653a20417072696c20382c2032303234202864617465206f6620696e697469616c20726573656172636820646973636c6f73757265290a0a2a2056657374696e67207363686564756c653a204c696e6561722076657374696e670a0a2a2057696c6c2062652073656e7420746f20746865206d6574612d676f7665726e616e6365206d756c74697369672c207472616e736665727265642c20616e642076657374656420746f20626c6f636b66756c2e0a0a0a0a23232042656e656669747320746f20454e532044414f0a0a0a0a2a2053657473206120706f73697469766520707265636564656e742074686174202a2a726573706f6e7369626c652076756c6e65726162696c69747920646973636c6f7375726520616e6420636f7272656374696f6e206172652072657761726465642a2a2c20656e636f75726167696e672066757475726520736563757269747920636f6e747269627574696f6e730a0a2a205072657365727665732044414f207472656173757279206c6971756964697479206279207573696e672070617274206f662074686520626f756e747920696e20454e5320746f6b656e7320696e7374656164206f662055534443206f72204554480a0a2a20456e68616e63657320676f7665726e616e636520736563757269747920627920696e6372656173696e6720746865206e756d626572206f6620656e67616765642c2073656375726974792d666f637573656420746f6b656e20686f6c646572730a0a232320436f6e636c7573696f6e0a0a427920617070726f76696e67207468697320636f6d70656e736174696f6e2c20454e532044414f2061636b6e6f776c65646765732074686520637269746963616c20696d706f7274616e6365206f6620736563757269747920726573656172636820616e642070726f61637469766520676f7665726e616e636520696d70726f76656d656e74732e205468652076657374696e672073747275637475726520656e7375726573206f6e676f696e6720636f6d6d69746d656e7420616e6420616c69676e7320696e63656e746976657320666f7220636f6e74696e75656420636f6e747269627574696f6e20746f20454e53277320736563757269747920616e642073746162696c6974792e00000000000000000000000000000000000000000000";

    function _selectFork() public override {
        vm.createSelectFork({ blockNumber: 21_089_400, urlOrAlias: "mainnet" });
    }

    function _proposer() public view override returns (address) {
        return 0x76A6D08b82034b397E7e09dAe4377C18F132BbB8;
    }

    function _beforeExecution() public override {
        USDCbalanceBefore = USDC.balanceOf(address(timelock));
        ENSbalanceBefore = ENS.balanceOf(address(timelock));
    }

    function _generateCallData()
        public
        override
        returns (
            address[] memory,
            uint256[] memory,
            string[] memory,
            bytes[] memory,
            string memory
        )
    {
         (targets, values, calldatas, description) =
            abi.decode(proposalCalldata, (address[], uint256[], bytes[], string));

        bytes[] memory internalCalldatas = new bytes[](2);
        internalCalldatas[0] = abi.encodeWithSelector(USDC.transfer.selector, receiver, expectedUSDCtransfer);
        internalCalldatas[1] = abi.encodeWithSelector(ENS.transfer.selector, receiver, expectedENStransfer);
        
        bytes memory expectedCalldata = abi.encode(
            targets,
            values,
            internalCalldatas,
            description
        );

        assertEq(calldatas, internalCalldatas);
        assertEq(proposalCalldata, expectedCalldata);

        return (targets, values, signatures, calldatas, description);
    }

    function _afterExecution() public override {
        USDCbalanceAfter = USDC.balanceOf(address(timelock));
        assertEq(USDCbalanceBefore, USDCbalanceAfter + expectedUSDCtransfer);
        assertNotEq(USDCbalanceAfter, USDCbalanceBefore);

        ENSbalanceAfter = ENS.balanceOf(address(timelock));
        assertEq(ENSbalanceBefore, ENSbalanceAfter + expectedENStransfer);
        assertNotEq(ENSbalanceAfter, ENSbalanceBefore);
    }

    function _isProposalSubmitted() public view override returns (bool) {
        return true;
    }
}
